---
fig.caption: yes
---

```{r setup, include=FALSE}
source("utilities/data.R")
source("utilities/plotLine.R")
source("utilities/CI.R")
source("utilities/modeling.R")
source("utilities/plotNSCDMap.R")
```


### Neural tube defects {#section-22}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q00")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for neural tube defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q00")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q00")[["pvalue"]])`).

```{r nt1, fig.cap= "Neural tube defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q00"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q00")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```

At a $5\%$ level, it was possible to see

- `r ifelse(modeling_trend(data = anom_ind, value = "q00")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q00")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for`r unique(anom_ind[grepl("^q00", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")[["coef"]], accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")$pvalue, accuracy = 0.01)`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q01")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q01")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q01")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q01", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q01")$coef, accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q01")$pvalue, accuracy = 0.01)`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q05")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q05")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q05")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q05", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$coef, accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$pvalue, accuracy = 0.01)`). 

```{r nt2, fig.cap="Neural tube defects: Anencephaly, Encephalocele, Spina bifida - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering neural tube defects
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q00|q01|q05"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```

Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`].


```{r nt3, fig.cap="Neural tube defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q00"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:nt3) shows how the prevalence of neural tube defects is geographically distributed in Nova Scotia by county in 3 different periods.

Neural tube defects appear to be more prevalent in western counties, although 3 counties (Digby, Queens and Shelburne) reported no data on this anomaly in the 2000-2010 period. Richmond is another county that showed consistently high values of prevalence over the years.

Guysborough is the only county where neural tube defects have never been reported.

### Selected central nervous system {#section-23}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q02")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected central nervous system.

```{r cns1, fig.cap= "Selected central nervous system - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q02"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q02")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q02")[["coef"]] < 0, "A decreasing", "San increasing"))` trend for `r unique(anom_ind[grepl("^q02", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q02")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q02")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q03")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q03", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q03")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q03")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q03")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q042", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q042")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q042")[["pvalue"]])`).


```{r cns2, fig.cap="Selected central nervous system: Microcephaly, Congenital hydrocephlus, Arhinencephaly/Holoprosencephaly - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q02|q03|q041|q042"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`] .

```{r cns3, fig.cap="Selected central nervous system - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q02"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:cns3) shows how the prevalence of selected congenital nervous system is geographically distributed in Nova Scotia by county in 3 different periods.

Selected congenital nervous system appear to be more prevalent in western counties, with the highest values for prevalence happening between 1988-2010, especially for Kings and the Annapolis counties.

### Selected sense organ defects {#section-24}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q110")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected sense organ defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q110")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q110")[["pvalue"]])`), even though rates appear to be increasing slightly.

```{r sod1, fig.cap= "Selected sense organ defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q110"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q110")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q110")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q110", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q110")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q110")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q160")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q160", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q160")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q160")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q300")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q300", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q300")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q300")[["pvalue"]])`).


```{r sod2, fig.cap="Selected sense organ defects: Anophtalmos/Microphtalmos, Anotia/Microtia, Choanal atresia - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q110|q160|q300"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q110")[["std"]], accuracy = 0.01)`].

```{r sod3, fig.cap="Selected sense organ defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q110"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:sod3) shows how the prevalence of selected sense organ defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected sense organ defects appear to be more prevalent in Richmond county.

Digby is the only county where selected sense organ defects have never been reported.

### Congenital heart defects {#section-25}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q200")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for congenital heart defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q200")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q200")[["pvalue"]])`).

```{r chd1, fig.cap= "Congenital heart defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q200"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q200")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q200")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q200", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q200")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q200")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q2031")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q2031", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q2031")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q212")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q212", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q212")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q212")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q213")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q213", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q213")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q213")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q234")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q234", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q234")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q234")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q251")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q251")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q251")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q251", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q251")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q251")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q251")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q251")[["pvalue"]])`).


```{r chd2, fig.cap="Congenital heart defects: Commom truncus, Discordant ventriculoarterial connection, Atrioventricular septal defect, Tetralogy of Fallot, Hypoplastic left heart syndrome - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q200|q2031|q212|q213|q234|q251"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q200")[["std"]], accuracy = 0.01)`].

```{r chd3, fig.cap="Congenital heart defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q200"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:chd3) shows how the prevalence of congenital heart defects is geographically distributed in Nova Scotia by county in 3 different periods.

Congenital heart defects appear to be more prevalent in Shelburne, and Richmond counties.

### Oro-facial clefts {#section-26}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q35")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q35")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for oro-facial clefts ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q35")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q35")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q35")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q35")[["pvalue"]])`).

```{r ofc1, fig.cap= "Oro-facial clefts - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q35"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q35")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q35")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q35")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q35", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q35")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q35")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q35")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q35")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q36")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q36")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q36")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q36", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q36")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q36")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q36")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q36")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q37")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q37")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q37")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q37", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q37")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q37")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q37")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q37")[["pvalue"]])`).

```{r ofc2, fig.cap="Oro-facial clefts: Cleft palate, Cleft lip, Cleft palate with cleft lip - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q35|q36|q37"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q35")[["std"]], accuracy = 0.01)`].

```{r ofc3, fig.cap="Oro-facial clefts - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q35"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:ofc3) shows how the prevalence of oro-facial clefts is geographically distributed in Nova Scotia by county in 3 different periods.

Oro-facial clefts appear to be more prevalent in the eastern zone (Victoria and Cape Breton counties).

Guysborough has not reported any oro-facial clefts occurrences for the last 2 periods (22 years).

### Selected gastrointestinal defects {#section-27}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q391")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q391")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q391")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected gastrointestinal defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q391")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q391")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q391")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q391")[["pvalue"]])`).

```{r gid1, fig.cap= "Selected gastrointestinal defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q391"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q391")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q391")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q391")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q391")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q391", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q391")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q391")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q391")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q391")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q41")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q41")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q41")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q41", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q41")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q41")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q41")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q41")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q420")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q420")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q420")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q420", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q420")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q420")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q420")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q420")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q431")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q431")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q431")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q431", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q431")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q431")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q431")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q431")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q442")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q442")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q442")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q442", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q442")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q442")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q442")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q442")[["pvalue"]])`).

```{r gid2, fig.cap="Selected gastrointestinal defects: Oesophageal atresia/stenosis, tracheoesophageal fistula, Small intestine absence/atresia/stenosis, Ano-rectal absence/atresia/stenosis, Hirschsprung disease, Atresia of bile ducts - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q390|q41|q420|q431|q442"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q391")[["std"]], accuracy = 0.01)`].

```{r gid3, fig.cap="Selected gastrointestinal defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q391"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:gid3) shows how the prevalence of selected gastrointestinal defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected gastrointestinal defects appear to be more prevalent in the eastern (Inverness, Victoria, Richmond, and Guysborough counties, although Victoria county has not reported any occurrences for the last period), and western zones (Yarmouth, Queens, and Digby counties).

### Selected genital anomalies {#section-28}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q531")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q531")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected genital anomalies ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q531")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q531")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q531")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q531")[["pvalue"]])`).

```{r ga1, fig.cap= "Selected genital anomalies - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q531"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q531")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q531")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q531")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q531", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q531")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q531")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q531")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q531")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q54")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q54")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q54")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q54", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q54")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q54")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q54")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q54")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q56")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q56")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q56")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q56", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q56")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q56")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q56")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q56")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q640")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q640")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q640")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q640", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q640")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q640")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q640")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q640")[["pvalue"]])`).


```{r ga2, fig.cap="Selected genital anomalies: Cryptorchidism/undescended testicles, Hypospadias, Indeterminate sex and pseudohermaphroditism, Epispadias - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q531|q54|q56|q640"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q531")[["std"]], accuracy = 0.01)`].

```{r ga3, fig.cap="Selected genital anomalies - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q531"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:ga3) shows how the prevalence of selected genital anomalies is geographically distributed in Nova Scotia by county in 3 different periods.

Selected genital anomalies appear to be more prevalent in the eastern (Victoria, and Cape Breton counties), and western zones (Yarmouth, Queens, Digby, and Lunenburg counties).

### Selected urinary tract defects {#section-29}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q601")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q601")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q601")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected urinary tract defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q601")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q601")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q601")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q601")[["pvalue"]])`).

```{r utd1, fig.cap= "Selected urinary tract defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q601"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q601")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q601")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q601")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q601")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q601", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q601")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q601")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q601")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q601")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q611")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q611")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q611")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q611", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q611")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q611")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q611")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q611")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q641")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q641")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q641")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q641", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q641")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q641")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q641")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q641")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q642")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q642")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q642")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q642", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q642")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q642")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q642")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q642")[["pvalue"]])`).


```{r utd2, fig.cap="Selected urinary tract defects: Renal agenesis, Cystic kidney, Cystic kidney, Lower urinary tract obstruction - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q601|q611|q641|q642"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q601")[["std"]], accuracy = 0.01)`].

```{r utd3, fig.cap="Selected urinary tract defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q601"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:utd3) shows how the prevalence of selected urinary tract defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected urinary tract defects appear to be more prevalent in the central (Halifax, and Hants counties), and western zones (Yarmouth, Shelburne, and Annapolis counties).

Guysborough has not reported any selected urinary tract defects occurrences for the last 2 periods (22 years).

### Hip dysplasia {#section-210}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q65")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q65")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q65")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for hip dysplasia ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q65")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q65")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q65")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q65")[["pvalue"]])`).

```{r hip1, fig.cap= "Hip dysplasia - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q65"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q65")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q65")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q65")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q65")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q65", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q65")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q65")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q65")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q65")[["pvalue"]])`).

Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q65")[["std"]], accuracy = 0.01)`].

```{r hip3, fig.cap="Hip dysplasia - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q65"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:hip3) shows how the prevalence of hip dysplasia is geographically distributed in Nova Scotia by county in 3 different periods.

Hip dysplasia appears to be more present all over Nova Scotia with high prevalence in the following counties by zones:

- Central: Halifax, and Hants counties.

- Northern: Pictou county.

- Western: Queens, and Lunenburg counties.

- Eastern: Guysborough county.

### Limb deficiency defects {#section-211}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q71")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q71")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q71")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for limb deficiency defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q71")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q71")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q71")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q71")[["pvalue"]])`).

```{r ldd1, fig.cap= "Limb deficiency defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q71"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q71")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q71")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q71")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q71")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q71", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q71")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q71")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q71")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q71")[["pvalue"]])`).

Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q71")[["std"]], accuracy = 0.01)`].

```{r ldd3, fig.cap="Limb deficiency defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q71"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:ldd3) shows how the prevalence of limb deficiency defects is geographically distributed in Nova Scotia by county in 3 different periods.

Limb deficiency defects appear to be more prevalent in the central (Hants county), western (Yarmouth county), and eastern zones (Inverness, Victoria, and Richmond).

Limb deficiency defects seem to be a rare anomaly since 7 (`r scales::percent(7/18, accuracy = 1)`) counties have not reported any occurrences for the last period (11 years).

### Selected abdominal wall defects {#section-212}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q792")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q792")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q792")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected abdominal wall defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q792")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q792")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q792")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q792")[["pvalue"]])`).

```{r awd1, fig.cap= "Selected abdominal wall defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q792"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q792")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q792")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q792")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q792")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q792", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q792")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q792")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q792")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q792")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q793")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q793")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q793")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q793", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q793")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q793")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q793")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q793")[["pvalue"]])`).

```{r awd2, fig.cap="Selected abdominal wall defects: Omphalocele/Exomphalos, Gastroschisis - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q792|q793"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q792")[["std"]], accuracy = 0.01)`].

```{r awd3, fig.cap="Selected abdominal wall defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q792"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:awd3) shows how the prevalence of selected abdominal wall defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected abdominal wall defects appear to be more prevalent in the western (Digby county), and northern zones (Pictou, Colchester, Cumberland counties).

Selected abdominal wall defects seem to be a rare anomaly since 9 (`r scales::percent(9/18, accuracy = 1)`) counties have not reported any occurrences for the last period (11 years).

### Selected chromosomal defects {#section-213}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q90")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q90")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q90")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for selected abdominal wall defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q90")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q90")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q90")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q90")[["pvalue"]])`).

```{r cd1, fig.cap= "Selected chromosomal defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q90"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q90")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            # marker = list(color = "black")
         hovertemplate = ~paste(
                    "<b>", cat, "-", BrthYear, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.01),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
```

At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q90")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q90")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q90")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q90", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q90")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q90")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q90")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q90")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q914")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q914")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q914")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q914", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q914")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q914")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q914")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q914")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q910")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q910")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q910")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q910", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q910")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q910")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q910")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q910")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q96")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q96")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q96")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q96", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q96")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q96")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q96")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q96")[["pvalue"]])`).

```{r cd2, fig.cap="Selected chromosomal defects: Down Syndrome, Trisomy 13 - Patau, Trisomy 18 - Edwards, Turner syndrome - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q90|q914|q910|q96"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q90")[["std"]], accuracy = 0.01)`].

```{r cd3, fig.cap="Selected chromosomal defects - Nova Scotia. The map shows the labels of the 35% highest values of prevalence in each period."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q90"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:awd3) shows how the prevalence of selected chromosomal defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected chromosomal defects appear to be more present all over Nova Scotia with high prevalence in the following counties by zones:

- Northern: Cumberland, Antigonish counties.

- Western: Digby, and Annapolis counties.

- Eastern: Guysborough, Cape Breton counties.