---
fig.caption: yes
params:
  year1: 2012
  year2: 2022
---

```{r setup, include=FALSE}
source("utilities/data.R")
source("utilities/plotLine.R")
source("utilities/CI.R")
source("utilities/modeling.R")
source("utilities/plotNSCDMap.R")
```

# Anomalies Overview {#chapter3}

## Neural tube defects {#section32}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "gr101")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(subset(anom, tolower(Diag) %in% "gr101")[["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "gr101")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "gr101")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "gr101")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "gr101")[["Birth_Year"]]))`.

Over the past 11 years `r paste0("(",params$year1,"-",params$year1+10,")")`, `r ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "gr101")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom %>% filter(tolower(Diag) %in% "gr101") %>% select(cat)))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "gr101")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "gr101")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "gr101")[["coef"]]), accuracy = 0.001)` per 10,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "gr101")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "gr101")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "gr101")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "gr101")[["coef"]]-1.96*modeling_trend(data = anom, value = "gr101")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "gr101")[["coef"]]+1.96*modeling_trend(data = anom, value = "gr101")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "gr101")[["coef"]]-1.96*modeling_trend(data = anom, value = "gr101")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "gr101")[["coef"]]+1.96*modeling_trend(data = anom, value = "gr101")[["std"]]), accuracy = 0.001)`], respectively).

```{r nt1, fig.cap="Neural tube defects - Prevalence"}
dta <- subset(anom, tolower(Diag) %in% "gr101") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "gr101")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines+markers",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom %>% filter(tolower(Diag) %in% "q00") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q00")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q00")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q00")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q00")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q00")[["pvalue"]],accuracy = 0.001))`).

```{r nt11, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q00") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q00") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q00")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines+markers",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom %>% filter(tolower(Diag) %in% "q01") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q01")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q01")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q01")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q01")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q01")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q01")[["pvalue"]],accuracy = 0.001))`).

```{r nt12, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q01") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q01") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q01")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom %>% filter(tolower(Diag) %in% "q05") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q05")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q05")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q05")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q05")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q05")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q05")[["pvalue"]],accuracy = 0.001))`).

```{r nt13, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q05") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q05") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q05")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected central nervous system defects {#section33}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "gr102")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(subset(anom, tolower(Diag) %in% "gr102")[["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "gr102")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "gr102")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "gr102")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "gr102")[["Birth_Year"]]))`.

Over the past 11 years `r paste0("(",params$year1,"-",params$year1+10,")")`, `r ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "gr102")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom %>% filter(tolower(Diag) %in% "gr102") %>% select(cat)))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "gr102")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "gr102")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "gr102")[["coef"]]), accuracy = 0.001)` per 10,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "gr102")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "gr102")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "gr102")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "gr102")[["coef"]]-1.96*modeling_trend(data = anom, value = "gr102")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "gr102")[["coef"]]+1.96*modeling_trend(data = anom, value = "gr102")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "gr102")[["coef"]]-1.96*modeling_trend(data = anom, value = "gr102")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "gr102")[["coef"]]+1.96*modeling_trend(data = anom, value = "gr102")[["std"]]), accuracy = 0.001)`], respectively).

```{r scn1, fig.cap="Selected central nervous system defects - Prevalence"}
dta <- subset(anom, tolower(Diag) %in% "gr102") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "gr102")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines+markers",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom %>% filter(tolower(Diag) %in% "q00") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q02")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q02")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q02")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q02")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q02")[["pvalue"]],accuracy = 0.001))`).

```{r scn11, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q02") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q02") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q02")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom %>% filter(tolower(Diag) %in% "q03") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q03")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q03")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q03")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q03")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q03")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q03")[["pvalue"]],accuracy = 0.001))`).

```{r scn12, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q03") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q03") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q03")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom %>% filter(tolower(Diag) %in% "q041") %>% select(cat) %>% distinct() %>% pull())`: there `r ifelse(modeling_trend(data = anom, value = "q041")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q041")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q041")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q041")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q041")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q041")[["pvalue"]],accuracy = 0.001))`).

```{r scn13, fig.cap=paste0(unique(anom %>% filter(tolower(Diag) %in% "q041") %>% select(cat) %>% distinct() %>% pull())," - Prevalence.")}
dta <- subset(anom, tolower(Diag) %in% "q041") %>% 
  select(CaseID, Birth_Year, count_brth_yr, Diag, cat) %>% 
  distinct() %>% 
  group_by(Birth_Year) %>% 
  mutate(total = n(),
         rate = total/count_brth_yr*10000) %>% 
  select(Birth_Year, rate, Diag, cat) %>% 
  distinct() %>% 
  ungroup()
  
xy <- modeling_anal(anom, "q041")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Estimated Prevalence:",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-c(model,total,count_brth_yr))
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected sense organ defects {#section34}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q110")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q110", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q110")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q110")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q110")[["Birth_Year"]]))`. From figure \@ref(fig:ssod1), the prevalence rate exhibited an upward trend from 1988 to 2003. Since then, the rate has gradually fluctuated downwards until reaching the current level.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q110")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q110", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q110")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q110")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q110")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]]-1.96*modeling_trend(data = anom, value = "q110")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]]+1.96*modeling_trend(data = anom, value = "q110")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q110")[["coef"]]-1.96*modeling_trend(data = anom, value = "q110")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q110")[["coef"]]+1.96*modeling_trend(data = anom, value = "q110")[["std"]]), accuracy = 0.001)`], respectively).

```{r ssod1, fig.cap="Selected sense organ defects - Prevalence"}
dta <- anom[grepl(tolower("q110"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q110")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q110", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q110")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q110")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q110")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q110")[["pvalue"]],accuracy = 0.001))`).

```{r ssod11, fig.cap=paste0(unique(anom[grepl("q110", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q110"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q110")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q160", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q160")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q160")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q160")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q160")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q160")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q160")[["pvalue"]],accuracy = 0.001))`).

```{r ssod12, fig.cap=paste0(unique(anom[grepl("q160", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q160"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q160")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q300", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q300")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q300")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q300")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q300")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q300")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q300")[["pvalue"]],accuracy = 0.001))`).

```{r ssod13, fig.cap=paste0(unique(anom[grepl("q300", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q300"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q300")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

<!-- ```{r ssod2, fig.cap="Selected sense organ defects: Anophtalmos/Microphtalmos, Anotia/Microtia, Choanal atresia - Prevalence"} -->
<!-- ## filtering neural tube defects -->
<!-- ## count anomaly by year -->
<!-- ## categorize them -->
<!-- # filtering total births: lvb + stillbirths -->

<!-- dta <- anom[grepl(tolower("q110|q160|q300"), -->
<!--                    tolower(Diag)) ] -->

<!-- if (knitr::is_html_output()){ -->
<!-- plot_line(data = dta, -->
<!--           var = "rate") -->
<!-- } else if (knitr::is_latex_output()){ -->
<!--   plot_line_pdf(data = dta, -->
<!--                 var = "rate") -->
<!-- } -->
<!-- ``` -->

Figure \@ref(fig:ssod3) shows how the prevalence of `r tolower(unique(anom[grepl("q110", tolower(Diag))][["cat"]]))` is geographically distributed in Nova Scotia by county between `r params$year1` and `r params$year2`.

In the past, `r tolower(unique(anom[grepl("q110", tolower(Diag))][["cat"]]))` appeared to be more prevalent in northern, western, and central counties. Lately, this predominance seems to have concentrated more towards the northern and western counties, with emphasis on Yarmouth, Shelburne, Kings, and Hants.

```{r ssod3, fig.cap=paste0("Selected sense organ defects - Nova Scotia. Shifts in counties between ", params$year1, " and ", params$year2, ".")}
 # filter data
dta <- anom_map[grepl(tolower("q110"),
                          tolower(Diag)) ] %>%
  .[,
    `:=` (total_anom = ifelse(count_anom < 5,
                              "< 5",
                              as.character(scales::comma(count_anom, accuracy = 1))),
          total_lvb_yr = ifelse(total_lvb_yr < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb_yr, accuracy = 1))))
  ] %>% 
  tidyr::complete(CDuid = sort(unique(cd_names$CDuid)),
                  nesting(time_cat, cat, Diag, Diagcat)
  ) %>% 
  # merge(cd_names,
  #       by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CDuid"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_cat",
                                 "count_anom","total_anom","total_lvb_yr",
                                 "rate","area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |>
  arrange(time_cat) |>
  mutate(Birth_Year = time_cat) |>
  sf::st_sf() |>
  sf::st_transform(4326)

if (knitr::is_html_output()){
  # tmap_mode("view")|>
  #   tm_view(projection = 4326)
  # plot_map(dta_map[,-1])
  knitr::include_url("images/maps/ssod1.html")
} else if(knitr::is_latex_output()){
  tmap_mode("plot")
  plot_map_pdf(dta_map)
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected congenital heart defects {#section35}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q200")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q200", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q200")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q200")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q200")[["Birth_Year"]]))`. From figure \@ref(fig:schd1), the prevalence rate exhibited an downward trend from 1988 to 2021 with subsequent peaks being smaller on 1998, 2010, and 2019.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q200")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q200", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q200")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q200")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q200")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]]-1.96*modeling_trend(data = anom, value = "q200")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]]+1.96*modeling_trend(data = anom, value = "q200")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q200")[["coef"]]-1.96*modeling_trend(data = anom, value = "q200")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q200")[["coef"]]+1.96*modeling_trend(data = anom, value = "q200")[["std"]]), accuracy = 0.001)`], respectively).

```{r schd1, fig.cap="Selected congenital heart defects - Prevalence"}
dta <- anom[grepl(tolower("q200"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q200")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q200", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q200")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q200")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q200")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q200")[["pvalue"]],accuracy = 0.001))`).

- `r unique(anom[grepl("q201", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q201")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q201")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q201")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q201")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q201")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q201")[["pvalue"]],accuracy = 0.001))`).

- `r unique(anom[grepl("q212", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q212")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q212")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q212")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q212")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q212")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q212")[["pvalue"]],accuracy = 0.001))`).

- `r unique(anom[grepl("q213", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q213")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q213")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q213")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q213")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q213")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q213")[["pvalue"]],accuracy = 0.001))`).

```{r schd11, fig.cap=paste0(unique(anom[grepl("q213", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q213"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q213")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q234", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q234")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q234")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q234")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q234")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q234")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q234")[["pvalue"]],accuracy = 0.001))`).

```{r schd12, fig.cap=paste0(unique(anom[grepl("q234", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q234"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q234")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q251", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q251")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q251")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q251")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q251")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q251")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q251")[["pvalue"]],accuracy = 0.001))`).

```{r schd13, fig.cap=paste0(unique(anom[grepl("q251", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q251"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q251")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Figure \@ref(fig:schd3) shows how the prevalence of `r tolower(unique(anom[grepl("q200", tolower(Diag))][["cat"]]))` is geographically distributed in Nova Scotia by county between `r params$year1` and `r params$year2`.

In the past, `r tolower(unique(anom[grepl("q200", tolower(Diag))][["cat"]]))` appeared to be an anomaly that occurred everywhere in the province being more prevalent in the eastern county of Richmond. Lately, this predominance seems to have consolidated and other eastern counties like Inverness and Victoria are also showing a high prevalence rate for `r tolower(unique(anom[grepl("q200", tolower(Diag))][["cat"]]))`.

```{r schd3, fig.cap=paste0("Selected congenital heart defects - Nova Scotia. Shifts in counties between ", params$year1, " and ", params$year2, ".")}
 # filter data
dta <- anom_map[grepl(tolower("q200"),
                          tolower(Diag)) ] %>%
  .[,
    `:=` (total_anom = ifelse(count_anom < 5,
                              "< 5",
                              as.character(scales::comma(count_anom, accuracy = 1))),
          total_lvb_yr = ifelse(total_lvb_yr < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb_yr, accuracy = 1))))
  ] %>% 
  tidyr::complete(CDuid = sort(unique(cd_names$CDuid)),
                  nesting(time_cat, cat, Diag, Diagcat)
  ) %>% 
  # merge(cd_names,
  #       by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CDuid"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_cat",
                                 "count_anom","total_anom","total_lvb_yr",
                                 "rate","area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |>
  arrange(time_cat) |>
  mutate(Birth_Year = time_cat) |>
  sf::st_sf() |>
  sf::st_transform(4326)

if (knitr::is_html_output()){
  # tmap_mode("view")|>
  #   tm_view(projection = 4326)
  # plot_map(dta_map[,-1])
  knitr::include_url("images/maps/schd1.html")
} else if(knitr::is_latex_output()){
  tmap_mode("plot")
  plot_map_pdf(dta_map)
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Oro-facial clefts {#section36}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q35")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q35", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q35")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q35")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q35")[["Birth_Year"]]))`. From figure \@ref(fig:ofc1), the prevalence rate exhibited an upward trend from 1988 to 2011 with drastic lower rates between 2012 and 2021.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q35")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q35", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q35")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q35")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q35")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]]-1.96*modeling_trend(data = anom, value = "q35")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]]+1.96*modeling_trend(data = anom, value = "q35")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q35")[["coef"]]-1.96*modeling_trend(data = anom, value = "q35")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q35")[["coef"]]+1.96*modeling_trend(data = anom, value = "q35")[["std"]]), accuracy = 0.001)`], respectively).

```{r ofc1, fig.cap="Oro-facial clefts - Prevalence"}
dta <- anom[grepl(tolower("q35"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q35")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q35", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q35")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q35")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q35")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q35")[["pvalue"]],accuracy = 0.001))`).

```{r ofc11, fig.cap=paste0(unique(anom[grepl("q35", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q35"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q35")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q36", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q36")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q36")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q36")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q36")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q36")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q36")[["pvalue"]],accuracy = 0.001))`).

```{r ofc12, fig.cap=paste0(unique(anom[grepl("q36", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q36"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q36")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q37", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q37")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q37")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q37")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q37")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q37")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q37")[["pvalue"]],accuracy = 0.001))`).

```{r ofc13, fig.cap=paste0(unique(anom[grepl("q37", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q37"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q37")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Figure \@ref(fig:ofc3) shows how the prevalence of `r tolower(unique(anom[grepl("q35", tolower(Diag))][["cat"]]))` is geographically distributed in Nova Scotia by county between `r params$year1` and `r params$year2`.

In the past, `r tolower(unique(anom[grepl("q35", tolower(Diag))][["cat"]]))` appeared to be more prevalent in northern, central, and eastern counties. Lately, this predominance seems to have concentrated more towards the northern and western counties, with emphasis on Yarmouth, Hants, and Colchester counties. In the eastern side of the province, Victoria county has the highest levels.

```{r ofc3, fig.cap=paste0("Oro-facial clefts - Nova Scotia. Shifts in counties between ", params$year1, " and ", params$year2, ".")}
 # filter data
dta <- anom_map[grepl(tolower("q35"),
                          tolower(Diag)) ] %>%
  .[,
    `:=` (total_anom = ifelse(count_anom < 5,
                              "< 5",
                              as.character(scales::comma(count_anom, accuracy = 1))),
          total_lvb_yr = ifelse(total_lvb_yr < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb_yr, accuracy = 1))))
  ] %>% 
  tidyr::complete(CDuid = sort(unique(cd_names$CDuid)),
                  nesting(time_cat, cat, Diag, Diagcat)
  ) %>% 
  # merge(cd_names,
  #       by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CDuid"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_cat",
                                 "count_anom","total_anom","total_lvb_yr",
                                 "rate","area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |>
  arrange(time_cat) |>
  mutate(Birth_Year = time_cat) |>
  sf::st_sf() |>
  sf::st_transform(4326)

if (knitr::is_html_output()){
  # tmap_mode("view")|>
  #   tm_view(projection = 4326)
  # plot_map(dta_map[,-1])
  knitr::include_url("images/maps/ofc1.html")
} else if(knitr::is_latex_output()){
  tmap_mode("plot")
  plot_map_pdf(dta_map)
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected gastrointestinal defects {#section37}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q390")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q390", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q390")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q390")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q390")[["Birth_Year"]]))`. From figure \@ref(fig:sgd1), the prevalence rate exhibited an upward trend from 1988 to 2005, while it has oscillated between highs and lows since then.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q390")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q390", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q390")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q390")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q390")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]]-1.96*modeling_trend(data = anom, value = "q390")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]]+1.96*modeling_trend(data = anom, value = "q390")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q390")[["coef"]]-1.96*modeling_trend(data = anom, value = "q390")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q390")[["coef"]]+1.96*modeling_trend(data = anom, value = "q390")[["std"]]), accuracy = 0.001)`], respectively).

```{r sgd1, fig.cap="Selected gastrointestinal defects - Prevalence"}
dta <- anom[grepl(tolower("q390"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q390")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q390", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q390")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q390")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q390")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q390")[["pvalue"]],accuracy = 0.001))`).

```{r sgd11, fig.cap=paste0(unique(anom[grepl("q390", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q390"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q390")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q410", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q410")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q410")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q410")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q410")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q410")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q410")[["pvalue"]],accuracy = 0.001))`).

```{r sgd12, fig.cap=paste0(unique(anom[grepl("q410", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q410"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q410")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q420", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q420")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q420")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q420")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q420")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q420")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q420")[["pvalue"]],accuracy = 0.001))`).

```{r sgd13, fig.cap=paste0(unique(anom[grepl("q420", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q420"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q420")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q431", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q431")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q431")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q431")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q431")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q431")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q431")[["pvalue"]],accuracy = 0.001))`).

```{r sgd14, fig.cap=paste0(unique(anom[grepl("q431", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q431"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q431")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q442", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q442")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q442")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q442")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q442")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q442")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q442")[["pvalue"]],accuracy = 0.001))`).

```{r sgd15, fig.cap=paste0(unique(anom[grepl("q442", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q442"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q442")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Figure \@ref(fig:sgd3) shows how the prevalence of `r tolower(unique(anom[grepl("q390", tolower(Diag))][["cat"]]))` is geographically distributed in Nova Scotia by county between `r params$year1` and `r params$year2`.

In the past, `r tolower(unique(anom[grepl("q390", tolower(Diag))][["cat"]]))` was found to be more prevalent in northern, western, and eastern counties. Presently, the prevalence distribution remains similar, with an emphasis on the counties of Yarmouth, Digby, Inverness and Richmond.

```{r sgd3, fig.cap=paste0("Selected gastrointestinal defects - Nova Scotia. Shifts in counties between ", params$year1, " and ", params$year2, ".")}
 # filter data
dta <- anom_map[grepl(tolower("q390"),
                          tolower(Diag)) ] %>%
  .[,
    `:=` (total_anom = ifelse(count_anom < 5,
                              "< 5",
                              as.character(scales::comma(count_anom, accuracy = 1))),
          total_lvb_yr = ifelse(total_lvb_yr < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb_yr, accuracy = 1))))
  ] %>% 
  tidyr::complete(CDuid = sort(unique(cd_names$CDuid)),
                  nesting(time_cat, cat, Diag, Diagcat)
  ) %>% 
  # merge(cd_names,
  #       by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CDuid"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_cat",
                                 "count_anom","total_anom","total_lvb_yr",
                                 "rate","area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |>
  arrange(time_cat) |>
  mutate(Birth_Year = time_cat) |>
  sf::st_sf() |>
  sf::st_transform(4326)

if (knitr::is_html_output()){
  # tmap_mode("view")|>
  #   tm_view(projection = 4326)
  # plot_map(dta_map[,-1])
  knitr::include_url("images/maps/sgd1.html")
} else if(knitr::is_latex_output()){
  tmap_mode("plot")
  plot_map_pdf(dta_map)
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected genital anomalies {#section38}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q531")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q531", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q531")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q531")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q531")[["Birth_Year"]]))`. From figure \@ref(fig:sga1), the prevalence rate has been exhibiting an upward trend with the peaks getting higher over the years.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q531")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q531", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q531")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q531")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q531")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]]-1.96*modeling_trend(data = anom, value = "q531")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]]+1.96*modeling_trend(data = anom, value = "q531")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q531")[["coef"]]-1.96*modeling_trend(data = anom, value = "q531")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q531")[["coef"]]+1.96*modeling_trend(data = anom, value = "q531")[["std"]]), accuracy = 0.001)`], respectively).

```{r sga1, fig.cap="Selected genital anomalies - Prevalence"}
dta <- anom[grepl(tolower("q531"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q531")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q531", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q531")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q531")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q531")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q531")[["pvalue"]],accuracy = 0.001))`).

```{r sga11, fig.cap=paste0(unique(anom[grepl("q531", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q531"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q531")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q540", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q540")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q540")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q540")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q540")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q540")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q540")[["pvalue"]],accuracy = 0.001))`).

```{r sga12, fig.cap=paste0(unique(anom[grepl("q540", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q540"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q540")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q56", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q56")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q56")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q56")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q56")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q56")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q56")[["pvalue"]],accuracy = 0.001))`).

```{r sga13, fig.cap=paste0(unique(anom[grepl("q56", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q56"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q56")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

- `r unique(anom[grepl("q640", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q640")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q640")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q640")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q640")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q640")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q640")[["pvalue"]],accuracy = 0.001))`).

```{r sga14, fig.cap=paste0(unique(anom[grepl("q640", tolower(Diag))][["cat"]])," - Prevalence")}
dta <- anom[grepl(tolower("q640"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q640")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Figure \@ref(fig:sga3) shows how the prevalence of `r tolower(unique(anom[grepl("q531", tolower(Diag))][["cat"]]))` is geographically distributed in Nova Scotia by county between `r params$year1` and `r params$year2`.

In the past, `r tolower(unique(anom[grepl("q531", tolower(Diag))][["cat"]]))` appeared to be more prevalent in western, and eastern counties. Lately, this predominance seems to have spread to the entire province with emphasis on Yarmouth, Digby, Queens, Pictou and Guysborough counties.

```{r sga3, fig.cap=paste0("Selected genital anomalies - Nova Scotia. Shifts in counties between ", params$year1, " and ", params$year2, ".")}
 # filter data
dta <- anom_map[grepl(tolower("q531"),
                          tolower(Diag)) ] %>%
  .[,
    `:=` (total_anom = ifelse(count_anom < 5,
                              "< 5",
                              as.character(scales::comma(count_anom, accuracy = 1))),
          total_lvb_yr = ifelse(total_lvb_yr < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb_yr, accuracy = 1))))
  ] %>% 
  tidyr::complete(CDuid = sort(unique(cd_names$CDuid)),
                  nesting(time_cat, cat, Diag, Diagcat)
  ) %>% 
  # merge(cd_names,
  #       by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CDuid"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_cat",
                                 "count_anom","total_anom","total_lvb_yr",
                                 "rate","area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |>
  arrange(time_cat) |>
  mutate(Birth_Year = time_cat) |>
  sf::st_sf() |>
  sf::st_transform(4326)

if (knitr::is_html_output()){
  # tmap_mode("view")|>
  #   tm_view(projection = 4326)
  # plot_map(dta_map[,-1])
  knitr::include_url("images/maps/sga1.html")
} else if(knitr::is_latex_output()){
  tmap_mode("plot")
  plot_map_pdf(dta_map)
}
```

```{asis, echo=knitr::is_latex_output()}
\clearpage
```

## Selected urinary tract defects {#section39}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q600")[["coef"]] < 0, "a decreasing", "an increasing"))` trend for `r tolower(unique(anom[grepl("q600", tolower(Diag))][["cat"]]))` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q600")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q600")[["pvalue"]],accuracy = 0.001))`) for the period `r paste0(min(modeling_anal(data = anom, value = "q600")[["Birth_Year"]])," - ",max(modeling_anal(data = anom, value = "q600")[["Birth_Year"]]))`. From figure \@ref(fig:sutd1), the prevalence rate exhibited an upward trend from 1988 to 2000. Since then, it has oscillated with highs and lows with no clear direction.

Over the past 10 years `r paste0("(",params$year10+1,"-",params$year10+10,")")`, `r ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] >= 0.05, "there is no evidence showing any trend", ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q600")[["coef"]] < 0, "there is evidence showing a decrease", "there is evidence showing an increase"))` in the prevalence rate of `r tolower(unique(anom[grepl("q600", tolower(Diag))][["cat"]]))`. On average, the prevalence rate for each subsequent year is `r scales::comma(exp(modeling_trend(data = anom, value = "q600")[["coef"]]), accuracy = 0.001)` times of the previous year's rate: (prevalence rate = exp(`r scales::comma(modeling_trend(data = anom, value = "q600")[["coef"]], accuracy = 0.001)`) = `r scales::comma(exp(modeling_trend(data = anom, value = "q600")[["coef"]]), accuracy = 0.001)` per 1,000 total births; $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom, value = "q600")[["coef"]], accuracy = 0.001)`, p-value = `r ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] < 0.0001,"< 0.0001",scales::comma(modeling_trend(data = anom, value = "q600")[["pvalue"]],accuracy = 0.001))`; $95\%$ CI for $\hat{\beta_{1}}$ and for the prevalence rate are given by $CI(95\%)_{\hat{\beta_{1}}}$:[`r scales::comma(modeling_trend(data = anom, value = "q600")[["coef"]]-1.96*modeling_trend(data = anom, value = "q600")[["std"]], accuracy = 0.001)`; `r scales::comma(modeling_trend(data = anom, value = "q600")[["coef"]]+1.96*modeling_trend(data = anom, value = "q600")[["std"]], accuracy = 0.001)`], and $CI(95\%)_{rate}$:[`r scales::comma(exp(modeling_trend(data = anom, value = "q600")[["coef"]]-1.96*modeling_trend(data = anom, value = "q600")[["std"]]), accuracy = 0.001)`; `r scales::comma(exp(modeling_trend(data = anom, value = "q600")[["coef"]]+1.96*modeling_trend(data = anom, value = "q600")[["std"]]), accuracy = 0.001)`], respectively).

```{r sutd1, fig.cap="Selected urinary tract defects - Prevalence"}
dta <- anom[grepl(tolower("q600"),
                   tolower(Diag)) ]
  
xy <- modeling_anal(anom, "q600")

if (knitr::is_html_output()){
p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~Birth_Year,
            y = ~rate,
            name = ifelse(xy[["model"]] %in% "nb",
                          "Negative Binomial GLM fit",
                          "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black"),
            marker = list(color = "black"),
         hovertemplate = ~paste(
                    "<b>", cat, "-", Birth_Year, "</b>",
                    "<br> Total estimated cases:",
                    ifelse(total_anom < 5,
                           "< 5",
                           as.character(scales::comma(total_anom,
                                                      accuracy = 1))),
                    "<br> Total births:",
                    ifelse(total_lvb_yr < 5,
                           "< 5",
                           as.character(scales::comma(total_lvb_yr,
                                                      accuracy = 1))),
                    "<br> Prevalence (*cases per 1,000 total births):",
                    scales::comma(rate,
                                  accuracy = 0.001),
                    "<extra></extra>" # removes the trace name from the hover text
                  )
         )
} else if(knitr::is_latex_output()){
  xy <- xy %>% 
  mutate(cat = ifelse(model %in% "nb",
         "Negative Binomial GLM fit",
         ifelse(model %in% "pois",
         "Poisson GLM fit", cat))) %>% 
    select(-model)
  
  new_dta <- rbind(dta, xy)
  
  plot_line_pdf(data = new_dta,
                var = "rate")
}
```

Based on the statistical analysis, at a $5\%$ level, it is possible to observe:

- `r unique(anom[grepl("q600", tolower(Diag))][["cat"]])`: there `r ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] >= 0.05, "is no significant", ifelse(modeling_trend(data = anom, value = "q600")[["pvalue"]] < 0.05 & modeling_trend(data = anom, value = "q600")[["coef"]] < 0, "is evidence of a decreasing", "is evidence of an increasing"))` trend ($\hat{\beta_{1}} =$ 