---
fig.caption: yes
---

```{r setup, include=FALSE}
source("utilities/data.R")
source("utilities/plotLine.R")
source("utilities/CI.R")
source("utilities/modeling.R")
source("utilities/plotNSCDMap.R")
```

### Neural tube defects {#section-22}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q00")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with neural tube defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q00")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q00")[["pvalue"]])`).

```{r nt1, fig.cap= "Neural tube defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q00"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q00")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```

At a $5\%$ level, it was possible to see

- `r ifelse(modeling_trend(data = anom_ind, value = "q00")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q00")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for`r unique(anom_ind[grepl("^q00", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")[["coef"]], accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")$pvalue, accuracy = 0.01)`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q01")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q01")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q01")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q01", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q01")$coef, accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q01")$pvalue, accuracy = 0.01)`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q05")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q05")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q05")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q05", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$coef, accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$pvalue, accuracy = 0.01)`). 

```{r nt2, fig.cap="Neural tube defects: Anencephaly, Encephalocele, Spina bifida - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering neural tube defects
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q00|q01|q05"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```

Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`].


```{r nt3, fig.cap="Neural tube defects - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q00"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:nt3) shows how the prevalence of neural tube defects is geographically distributed in Nova Scotia by county in 3 different periods.

Neural tube defects appear to be more prevalent in western counties, although 3 counties (Digby, Queens and Shelburne) reported no data on this anomaly in the 2000-2010 period. Richmond is another county that showed consistently high values of prevalence over the years.

Guysborough is the only county where neural tube defects have never been reported.

### Selected central nervous system {#section-23}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q02")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with selected central nervous system.

```{r cns1, fig.cap= "Selected central nervous system - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q02"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q02")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q02")[["coef"]] < 0, "A decreasing", "San increasing"))` trend for `r unique(anom_ind[grepl("^q02", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q02")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q02")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q03")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q03", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q03")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q03")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q03")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q042", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q042")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q042")[["pvalue"]])`).


```{r cns2, fig.cap="Selected central nervous system: Microcephaly, Congenital hydrocephlus, Arhinencephaly/Holoprosencephaly - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q02|q03|q041|q042"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`] .

```{r cns3, fig.cap="Selected central nervous system - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q02"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:cns3) shows how the prevalence of selected congenital nervous system is geographically distributed in Nova Scotia by county in 3 different periods.

Selected congenital nervous system appear to be more prevalent in western counties, with the highest values for prevalence happening between 1988-2010, especially for Kings and the Annapolis counties.

### Selected sense organ defects {#section-24}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q110")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with selected sense organ defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q110")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q110")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q110")[["pvalue"]])`), even though rates appear to be increasing slightly.

```{r sod1, fig.cap= "Selected sense organ defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q110"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q110")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q110")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q110", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q110")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q110")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q110")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q160")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q160", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q160")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q160")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q160")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q300")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q300", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q300")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q300")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q300")[["pvalue"]])`).


```{r sod2, fig.cap="Selected sense organ defects: Anophtalmos/Microphtalmos, Anotia/Microtia, Choanal atresia - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q110|q160|q300"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`].

```{r sod3, fig.cap="Selected sense organ defects - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q110"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:sod3) shows how the prevalence of selected sense organ defects is geographically distributed in Nova Scotia by county in 3 different periods.

Selected sense organ defects appear to be more prevalent in Richmond county.

Digby is the only county where selected sense organ defects have never been reported.

### Congenital heart defects {#section-25}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q200")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with congenital heart defects ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp, value = "q200")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp, value = "q200")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp, value = "q200")[["pvalue"]])`).

```{r chd1, fig.cap= "Congenital heart defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q200"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q200")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```


At a $5\%$ level, it was possible to see 

- `r ifelse(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q200")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q200", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q200")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q200")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q200")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q2031")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q2031", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q2031")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q2031")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q212")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q212", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q212")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q212")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q212")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q213")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q213", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q213")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q213")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q213")[["pvalue"]])`).

- `r ifelse(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]] >= 0.05, "No significant", ifelse(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]] < 0.05 & modeling_trend(data = anom_ind, value = "q234")[["coef"]] < 0, "A decreasing", "An increasing"))` trend for `r unique(anom_ind[grepl("^q234", tolower(qcode))][["cat"]])` ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q234")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q234")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q234")[["pvalue"]])`).


```{r chd2, fig.cap="Congenital heart defects: Commom truncus, Discordant ventriculoarterial connection, Atrioventricular septal defect, Tetralogy of Fallot, Hypoplastic left heart syndrome - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q200|q2031|q212|q213|q234"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]])`). The $95\%$ for $\hat{\beta_{1}}$ is given by CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`].

```{r chd3, fig.cap="Congenital heart defects - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q200"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

# nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
plot_map(dta_map)
# m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
# m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

# tmap_arrange(m1,m2,m3,
#              ncol = 2)
```


Figure \@ref(fig:chd3) shows how the prevalence of congenital heart defects is geographically distributed in Nova Scotia by county in 3 different periods.

Congenital heart defects appear to be more prevalent in Richmond county.

Digby is the only county where selected sense organ defects have never been reported.