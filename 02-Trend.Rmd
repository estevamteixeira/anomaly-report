---
fig.caption: yes
---

```{r setup, include=FALSE}
source("utilities/data.R")
source("utilities/plotLine.R")
source("utilities/CI.R")
source("utilities/modeling.R")
source("utilities/plotNSCDMap.R")
```

### Neural tube defects {#section-22}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q00")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with neural tube defects as a whole or within the sub-group encephalocele.

```{r nt1, fig.cap= "Neural tube defects - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q00"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q00")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```

At a $5\%$ level, it was possible to see a slightly increasing and decreasing trend for anencephaly ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")[["coef"]], accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q00")$pvalue, accuracy = 0.01)`), and spina bifida ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$coef, accuracy = 0.01)`, $p-value=$ `r scales::comma(modeling_trend(data = anom_ind, value = "q05")$pvalue, accuracy = 0.01)`), respectively. 

```{r nt3, fig.cap="Neural tube defects: Anencephaly, Encephalocele, Spina bifida - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering neural tube defects
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q00|q01|q05"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```

Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["pvalue"]])`); $95\%$ CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q00")[["std"]], accuracy = 0.01)`].


```{r nt2, fig.cap="Neural tube defects - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q00"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
source("utilities/plotNSCDMap.R")
m1 <- plot_map(dta_map %>% filter(time_lab %in% nplots[1]))
m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

tmap_arrange(m1,m2,m3,
             ncol = 2)
```


Figure \@ref(fig:nt2) shows how the prevalence of neural tube defects is geographically distributed in Nova Scotia by county.

Neural tube defects appear to be more prevalent in western counties, although 3 counties (Digby, Queens and Shelburne) reported no data on this anomaly in the 2000-2010 period.

Guysborough is the only county where neural tube defects have never been reported.

### Selected central nervous system {#section-23}

At a $5\%$ level, there is `r ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] >= 0.05, "no significant", ifelse(modeling_trend(data = anom_grp, value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp, value = "q02")[["coef"]] < 0, "a decreasing", "an increasing"))` trend with selected central nervous system.

```{r scns1, fig.cap= "Selected central nervous system - Total reported cases. Use your mouse to hover over and see extra information."}
dta <- anom_grp[grepl(tolower("q02"),
                   tolower(qcode)) ]
  
xy <- modeling_anal(anom_grp, "q02")

p1 <- plot_line(data = dta,
                var = "rate")

p1 %>% 
  add_trace(data = xy,
            x = ~BrthYear,
            y = ~rate,
            name = ifelse(var(dta$total_anom,
         na.rm = TRUE)/mean(dta$total_anom,
                            na.rm = TRUE) > 2,
         "Negative Binomial GLM fit",
         "Poisson GLM fit"),
            mode = "lines",
            line = list(color = "black")
            # marker = list(color = "black")
         )
```


At a $5\%$ level, it was possible to see a slightly decreasing trend for anencephaly ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q02")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q02")[["pvalue"]])`), and congenital hydrocephalus ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q03")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q03")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q03")[["pvalue"]])`), respectively. No significant trend was detected for arhinencephaly/holoprosencephaly ($\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_ind, value = "q042")[["coef"]], accuracy = 0.01)`, $p-value=$ `r ifelse(is.numeric(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]]), scales::comma(modeling_trend(data = anom_ind, value = "q042")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_ind, value = "q042")[["pvalue"]])`)


```{r snsc3, fig.cap="Selected central nervous system: Microcephaly, Congenital hydrocephlus, Arhinencephaly/Holoprosencephaly - Total reported cases. Use your mouse to hover over and see extra information."}
## filtering selected central nervous system
## count anomaly by year
## categorize them
# filtering total births: lvb + stillbirths

dta <- anom_ind[grepl(tolower("q02|q03|q041|q042"),
                   tolower(qcode)) ]

plot_line(data = dta,
          var = "rate")
```


Overall, the prevalence rates have `r ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] >= 0.05, "been stable", ifelse(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]] < 0.05 & modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]] < 0, "decreased", "increased"))` over the past 10 years - 2012-2021: $\hat{\beta_{1}} =$ `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]], accuracy = 0.01)`, p-value = `r ifelse(is.numeric(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]]), scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]], accuracy = 0.01), modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["pvalue"]])`); $95\%$ CI:[`r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]-1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`; `r scales::comma(modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["coef"]]+1.96*modeling_trend(data = anom_grp[BrthYear > 2011], value = "q02")[["std"]], accuracy = 0.01)`].

```{r scns2, fig.cap="Selected central nervous system - Nova Scotia."}
 # filter data
dta <- anom_grp_map[grepl(tolower("q02"),
                          tolower(qcode)) ] %>%
  .[,
    `:=` (total_anom = ifelse(total_anom < 5,
                              "< 5",
                              as.character(scales::comma(total_anom, accuracy = 1))),
          total_lvb = ifelse(total_lvb < 5,
                             "< 5",
                             as.character(scales::comma(total_lvb, accuracy = 1))))
  ] %>% 
  tidyr::complete(CD_UID = sort(unique(cd_names$CD_UID)),
                  nesting(cat, qcode, qcodecat, time_cat, time_lab)
  ) %>% 
  merge(cd_names,
        by = c("CD_UID")) %>% 
  setDT()

nplots <- sort(unique(dta$time_lab))

dta_map <- merge(cd_shp,
                 dta,
                 by.x = c("GeoUID"),
                 by.y = c("CD_UID"),
                 all.x = TRUE)[,
                               c("GeoUID", "name","cat","cd_type","time_lab",
                                 "total_anom","total_lvb","rate",
                                 "area","geometry")
                 ][,
                   `:=` (rate = data.table::fifelse(!rate %in% 0,
                                                    rate,
                                                    NA_integer_))] |> 
  sf::st_sf() |>
  sf::st_transform(4326)

# build maps
# source("utilities/plotNSCDMap.R")
m1 <- plot_map(dta_map %>% filter(time_lab %in% nplots[1]))
m2 <- plot_map(dta_map %>% filter(time_lab %in% nplots[2]))
m3 <- plot_map(dta_map %>% filter(time_lab %in% nplots[3]))

tmap_arrange(m1,m2,m3,
             ncol = 2)
```


Figure \@ref(fig:scns2) shows how the prevalence of selected congenital nervous system is geographically distributed in Nova Scotia by county.

Selected congenital nervous system appear to be more prevalent in western counties, with high values for prevalence between 1988-2010, especially for Kings and the Annapolis counties.

